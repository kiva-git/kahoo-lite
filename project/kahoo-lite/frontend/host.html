<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kahoo Lite - Host</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1 class="h1">主持人控制台</h1>
            <div class="sub">Host view · realtime monitor</div>
          </div>
        </div>
        <a class="link" href="/">回首頁</a>
      </div>

      <div class="grid">
        <section class="card col-8">
          <h3>房間控制</h3>
          <div class="row">
            <input id="hostName" placeholder="主持人名稱" />
            <button class="primary" onclick="createRoom()">建立房間</button>
            <button class="ghost" onclick="startGame()">開始遊戲</button>
            <button class="ghost" onclick="nextQ()">下一題</button>
            <button class="ghost fullscreen-btn" onclick="toggleFullscreenQuestion()">全螢幕題目</button>
          </div>
          <p id="roomInfo">尚未建立房間</p>
          <p id="shareLink"></p>
          <div id="qrWrap" style="display:none; margin-top:10px;">
            <p>玩家掃碼加入：</p>
            <img id="qrImg" alt="Player QR Code" style="width:180px;height:180px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#fff;padding:6px;" />
          </div>
        </section>

        <section class="card col-4">
          <h3>回合狀態</h3>
          <div class="badge" id="lockState">狀態：-</div>
          <p>倒數</p>
          <div class="stat" id="timer">-</div>
          <p id="question">尚未連線</p>
        </section>

        <section class="card col-6">
          <h3>玩家作答狀態</h3>
          <ul class="list" id="players"></ul>
        </section>

        <section class="card col-6">
          <h3>排行榜</h3>
          <ul class="list board-anim" id="board"></ul>
        </section>
      </div>
    </div>

    <div id="fullscreenQuestion" class="fullscreen-question">
      <div class="full-inner">
        <button class="ghost" onclick="toggleFullscreenQuestion()">離開全螢幕</button>
        <div class="full-meta" id="fullMeta">Q1 · 倒數 -</div>
        <div class="full-title" id="fullQuestion">-</div>
        <div class="choices" id="fullChoices"></div>
      </div>
    </div>

    <script>
      const API = window.location.port === "5500" ? "http://127.0.0.1:8000" : "";
      const WS_BASE = window.location.port === "5500"
        ? "ws://127.0.0.1:8000"
        : `${window.location.protocol === "https:" ? "wss" : "ws"}://${window.location.host}`;
      let ws = null;
      let currentPin = "";
      let timerInterval = null;
      let secondsLeft = 0;
      const colorClasses = ["red", "blue", "yellow", "green"];

      async function createRoom() {
        const host_name = (document.getElementById("hostName").value || "Host").trim();
        const res = await fetch(`${API}/rooms`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ host_name }),
        });
        const data = await res.json();
        currentPin = data.pin;

        document.getElementById("roomInfo").textContent = `房間 PIN: ${data.pin}`;

        const joinPath = `/player.html?pin=${data.pin}`;
        const joinUrl = `${window.location.origin}${joinPath}`;
        document.getElementById("shareLink").innerHTML = `玩家連結：<a class="link" href="${joinPath}" target="_blank">${joinPath}</a><br/><small>${joinUrl}</small>`;

        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(joinUrl)}`;
        const qrImg = document.getElementById("qrImg");
        qrImg.src = qrApi;
        document.getElementById("qrWrap").style.display = "block";

        connectWS(data.pin);
      }

      async function startGame() {
        if (!currentPin) return alert("請先建立房間");
        await fetch(`${API}/rooms/${currentPin}/start`, { method: "POST" });
      }

      async function nextQ() {
        if (!currentPin) return alert("請先建立房間");
        await fetch(`${API}/rooms/${currentPin}/next`, { method: "POST" });
      }

      function toggleFullscreenQuestion() {
        const el = document.getElementById("fullscreenQuestion");
        el.classList.toggle("show");
      }

      function connectWS(pin) {
        if (ws) ws.close();
        ws = new WebSocket(`${WS_BASE}/ws/${pin}`);
        ws.onopen = () => ws.send("host_connected");
        ws.onmessage = (evt) => renderState(JSON.parse(evt.data));
      }

      function renderState(s) {
        document.getElementById("question").textContent = `Q${s.current_q + 1}: ${s.question}`;

        secondsLeft = s.seconds_left ?? 0;
        document.getElementById("timer").textContent = `${secondsLeft}s`;

        const lockEl = document.getElementById("lockState");
        lockEl.textContent = s.question_locked
          ? `狀態：已鎖題（${s.answered_count} 人作答）`
          : `狀態：作答中（${s.answered_count} 人作答）`;
        lockEl.className = `badge ${s.question_locked ? 'status warn' : 'status ok'}`;

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (secondsLeft > 0) {
            secondsLeft -= 1;
            document.getElementById("timer").textContent = `${secondsLeft}s`;
            const meta = document.getElementById("fullMeta");
            if (meta) meta.textContent = `Q${s.current_q + 1} · 倒數 ${secondsLeft}s`;
          }
        }, 1000);

        const players = document.getElementById("players");
        players.innerHTML = "";
        (s.players || []).forEach((p) => {
          const li = document.createElement("li");
          const last = p.last_answer_correct === null ? "未作答" : (p.last_answer_correct ? "✅" : "❌");
          li.textContent = `${p.name} (${last})`;
          players.appendChild(li);
        });

        const board = document.getElementById("board");
        board.innerHTML = "";
        (s.players || []).sort((a,b)=>b.score-a.score).forEach((p, i) => {
          const li = document.createElement("li");
          li.textContent = `#${i+1} ${p.name}: ${p.score}`;
          board.appendChild(li);
        });

        // fullscreen mirror
        document.getElementById("fullMeta").textContent = `Q${s.current_q + 1} · 倒數 ${s.seconds_left ?? 0}s`;
        document.getElementById("fullQuestion").textContent = s.question;
        const fullChoices = document.getElementById("fullChoices");
        fullChoices.innerHTML = "";
        (s.choices || []).forEach((c, i) => {
          const b = document.createElement("button");
          b.className = `choice ${colorClasses[i % colorClasses.length]}`;
          b.textContent = `${i + 1}. ${c}`;
          b.disabled = true;
          fullChoices.appendChild(b);
        });
      }
    </script>
  </body>
</html>
