<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kahoo Lite - Player</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1 class="h1">玩家作答頁</h1>
            <div class="sub">Player view · quick answer bonus</div>
          </div>
        </div>
        <a class="link" href="/">回首頁</a>
      </div>

      <div class="grid">
        <section class="card col-8">
          <h3>加入房間</h3>
          <div class="row">
            <input id="pin" placeholder="房間 PIN" />
            <input id="playerName" placeholder="玩家名稱" />
            <button class="primary" onclick="joinRoom()">加入</button>
          </div>
          <p id="status">尚未加入</p>
        </section>

        <section class="card col-4">
          <h3>回合資訊</h3>
          <div class="badge" id="lockState">狀態：-</div>
          <p>倒數</p>
          <div class="stat" id="timer">-</div>
          <p>我的分數：<strong id="myScore">0</strong></p>
        </section>

        <section class="card col-12">
          <h3 id="question">等待主持人開始</h3>
          <div class="choices" id="choices"></div>
        </section>
      </div>
    </div>

    <script>
      const API = window.location.port === "5500" ? "http://127.0.0.1:8000" : "";
      const WS_BASE = window.location.port === "5500"
        ? "ws://127.0.0.1:8000"
        : `${window.location.protocol === "https:" ? "wss" : "ws"}://${window.location.host}`;
      let ws = null;
      let timerInterval = null;
      let secondsLeft = 0;
      let lastQuestionIndex = -1;
      let answeredCurrent = false;
      const colorClasses = ["red", "blue", "yellow", "green"];

      const params = new URLSearchParams(location.search);
      const pinFromQuery = params.get("pin");
      if (pinFromQuery) document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("pin").value = pinFromQuery;
      });

      function v(id){ return document.getElementById(id).value.trim(); }

      async function joinRoom() {
        const pin = v("pin");
        const name = v("playerName") || "Player";
        const res = await fetch(`${API}/rooms/join`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pin, name }),
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById("status").textContent = `加入失敗：${data.detail || "未知錯誤"}`;
          return;
        }
        document.getElementById("status").textContent = data.reconnected ? `已重連：${name}` : `加入成功：${name}`;
        connectWS(pin);
      }

      async function submit(choiceIndex) {
        const pin = v("pin");
        const name = v("playerName") || "Player";
        const res = await fetch(`${API}/rooms/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pin, name, choice_index: choiceIndex }),
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById("status").textContent = `送出失敗：${data.detail || "未知錯誤"}`;
          return;
        }
        answeredCurrent = true;
        document.getElementById("status").textContent = data.correct
          ? `答對了 ✅ (+${data.bonus}分)`
          : "答錯了 ❌";
      }

      function connectWS(pin) {
        if (ws) ws.close();
        ws = new WebSocket(`${WS_BASE}/ws/${pin}`);
        ws.onopen = () => ws.send("player_connected");
        ws.onmessage = (evt) => renderState(JSON.parse(evt.data));
      }

      function renderState(s) {
        const started = !!s.started;

        if (s.current_q !== lastQuestionIndex) {
          lastQuestionIndex = s.current_q;
          answeredCurrent = false;
        }

        document.getElementById("question").textContent = started
          ? `Q${s.current_q + 1}. ${s.question}`
          : "等待主持人開始遊戲…";

        secondsLeft = s.seconds_left ?? 0;
        document.getElementById("timer").textContent = `${secondsLeft}s`;

        const lockEl = document.getElementById("lockState");
        lockEl.textContent = s.question_locked ? "狀態：已鎖題" : "狀態：作答中";
        lockEl.className = `badge ${s.question_locked ? 'status warn' : 'status ok'}`;

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (secondsLeft > 0) {
            secondsLeft -= 1;
            document.getElementById("timer").textContent = `${secondsLeft}s`;
          }
        }, 1000);

        const choices = document.getElementById("choices");
        choices.innerHTML = "";
        (s.choices || []).forEach((c, i) => {
          const b = document.createElement("button");
          b.className = `choice ${colorClasses[i % colorClasses.length]}`;
          b.textContent = `${i + 1}. ${c}`;
          b.disabled = !started || s.question_locked || answeredCurrent;
          b.onclick = () => submit(i);
          choices.appendChild(b);
        });

        if (!started) {
          document.getElementById("status").textContent = "尚未開始，請等主持人按開始";
        } else if (s.question_locked) {
          document.getElementById("status").textContent = "本題已鎖題，等待下一題";
        }

        const me = (s.players || []).find(p => p.name === (v("playerName") || "Player"));
        document.getElementById("myScore").textContent = me ? String(me.score) : "0";
      }
    </script>
  </body>
</html>
